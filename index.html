<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Estoque</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --bg: #f4f7f6;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        header { border-bottom: 2px solid var(--primary); margin-bottom: 20px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .form-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        input, select, button { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        
        .full-width { grid-column: span 2; }
        button { cursor: pointer; border: none; transition: 0.3s; }
        .btn-add { background: var(--success); color: white; }
        .btn-save { background: var(--accent); color: white; width: 100%; margin-top: 10px; }
        .btn-scan { background: #e67e22; color: white; }
        .btn-pdf { background: #e74c3c; color: white; margin-top: 20px; }

        .search-section { background: #eee; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: var(--primary); color: white; }
        tr:nth-child(even) { background: #f9f9f9; }

        /* Estilos para Celular */
        @media (max-width: 600px) {
            .form-group { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            table { font-size: 12px; display: block; overflow-x: auto; }
        }

        #interactive.viewport { width: 100%; height: 250px; border: 2px solid #333; margin: 10px 0; display: none; }
        #interactive.viewport canvas, video { width: 100%; height: 100%; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Estoque Geral</h1>
            <p id="data-atual"></p>
        </div>
        <button onclick="salvarLocal()" class="btn-save" style="width: auto; padding: 10px 20px;">üíæ Salvar Tudo</button>
    </header>

    <div class="search-section">
        <h3>üîç Buscar no Estoque</h3>
        <input type="text" id="inputBusca" placeholder="C√≥digo, Descri√ß√£o ou C√≥digo de Barras..." onkeyup="buscar()">
        <button class="btn-scan" onclick="iniciarScanner('busca')">üì∑ Scan</button>
    </div>

    <div id="interactive" class="viewport"></div>

    <div class="form-group">
        <input type="text" id="desc" placeholder="Descri√ß√£o do Produto" class="full-width">
        <input type="text" id="ref" placeholder="Refer√™ncia">
        <input type="number" id="qtd" placeholder="Quantidade">
        <input type="number" id="valor" placeholder="Valor Unit√°rio (R$)">
        <div style="display: flex; gap: 5px;">
            <input type="text" id="barcode" placeholder="C√≥digo de Barras" style="flex-grow: 1;">
            <button class="btn-scan" onclick="iniciarScanner('cadastro')">üì∑</button>
        </div>
        <button class="btn-add full-width" onclick="adicionarProduto()">‚ûï Adicionar Produto</button>
    </div>

    <table id="tabelaEstoque">
        <thead>
            <tr>
                <th>C√≥d.</th>
                <th>Descri√ß√£o</th>
                <th>Refer√™ncia</th>
                <th>Qtd</th>
                <th>Valor</th>
                <th>Barras</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="listaProdutos"></tbody>
    </table>

    <button class="btn-pdf" onclick="gerarPDF()">üìÑ Gerar Relat√≥rio PDF</button>
</div>

<script>
    let estoque = JSON.parse(localStorage.getItem('estoque_db')) || [];
    let proximoId = estoque.length > 0 ? Math.max(...estoque.map(p => p.id)) + 1 : 1;
    let scannerDestino = '';

    // Inicializa√ß√£o
    document.getElementById('data-atual').innerText = `Data: ${new Date().toLocaleDateString()}`;
    renderizarTabela();

    function adicionarProduto() {
        const p = {
            id: proximoId++,
            desc: document.getElementById('desc').value,
            ref: document.getElementById('ref').value,
            qtd: document.getElementById('qtd').value,
            valor: document.getElementById('valor').value,
            barcode: document.getElementById('barcode').value
        };

        if(!p.desc) return alert("Preencha a descri√ß√£o!");
        
        estoque.push(p);
        limparCampos();
        renderizarTabela();
    }

    function limparCampos() {
        ['desc', 'ref', 'qtd', 'valor', 'barcode'].forEach(id => document.getElementById(id).value = '');
    }

    function renderizarTabela(dados = estoque) {
        const corpo = document.getElementById('listaProdutos');
        corpo.innerHTML = '';
        dados.forEach((p, index) => {
            corpo.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td><input type="text" value="${p.desc}" onchange="editar(${index}, 'desc', this.value)"></td>
                    <td><input type="text" value="${p.ref}" onchange="editar(${index}, 'ref', this.value)"></td>
                    <td><input type="number" value="${p.qtd}" onchange="editar(${index}, 'qtd', this.value)" style="width:50px"></td>
                    <td><input type="number" value="${p.valor}" onchange="editar(${index}, 'valor', this.value)" style="width:70px"></td>
                    <td>${p.barcode}</td>
                    <td><button onclick="remover(${index})" style="background:red; color:white;">X</button></td>
                </tr>
            `;
        });
    }

    function editar(index, campo, valor) {
        estoque[index][campo] = valor;
    }

    function remover(index) {
        if(confirm("Deseja excluir este item?")) {
            estoque.splice(index, 1);
            renderizarTabela();
        }
    }

    function salvarLocal() {
        localStorage.setItem('estoque_db', JSON.stringify(estoque));
        alert("Altera√ß√µes salvas com sucesso!");
    }

    function buscar() {
        const termo = document.getElementById('inputBusca').value.toLowerCase();
        const filtrados = estoque.filter(p => 
            p.id.toString().includes(termo) || 
            p.desc.toLowerCase().includes(termo) || 
            p.barcode.includes(termo)
        );
        renderizarTabela(filtrados);
    }

    // Fun√ß√£o de Scanner de C√≥digo de Barras
    function iniciarScanner(destino) {
        scannerDestino = destino;
        const divScanner = document.getElementById('interactive');
        divScanner.style.display = 'block';

        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: divScanner },
            decoder: { readers: ["ean_reader", "code_128_reader"] }
        }, function(err) {
            if (err) return console.error(err);
            Quagga.start();
        });

        Quagga.onDetected((data) => {
            const code = data.codeResult.code;
            if(scannerDestino === 'cadastro') {
                document.getElementById('barcode').value = code;
            } else {
                document.getElementById('inputBusca').value = code;
                buscar();
            }
            Quagga.stop();
            divScanner.style.display = 'none';
        });
    }

    // Gera√ß√£o de Relat√≥rio PDF
    function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.text("Relat√≥rio de Estoque", 14, 15);
        doc.setFontSize(10);
        doc.text(`Data: ${new Date().toLocaleDateString()}`, 14, 22);

        const rows = estoque.map(p => [p.id, p.desc, p.qtd, `R$ ${p.valor}`]);
        
        doc.autoTable({
            head: [['ID', 'Descri√ß√£o', 'Qtd', 'Valor']],
            body: rows,
            startY: 30
        });

        doc.save("estoque.pdf");
    }
</script>

</body>
</html>
